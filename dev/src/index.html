<!DOCTYPE html>
<html lang="en">

<head>
  <title>Botfront - Web Chat</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body style="background: black;">
  <!-- <body style="background-image: url(https://upload.wikimedia.org/wikipedia/commons/4/42/Main_menu_of_Wikipedia.png);"> -->
  <a href="#" onclick="WebChat.send('/chitchat.greet')">Send chitchat.greet without text</a>
  <br />
  <a href="#" onclick="WebChat.send('/chitchat.greet', 'salut')">Send chitchat.greet with text</a>
  <span style="height: 400px; display: block;">test</span>
  <span style="height: 400px; display: block;">test</span>
  <span style="height: 400px; display: block;">test</span>
  <h1 class="test"> test</h1>
  <button class="my-button" style="margin-left: 450px"> MY BUTTON</button>

  <!-- –í–ê–ñ–ù–û: –ó–∞–≥—Ä—É–∂–∞–µ–º WebChat –±–∏–±–ª–∏–æ—Ç–µ–∫—É –ü–ï–†–ï–î –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π -->
  <script src="index.js" type="text/javascript"></script>

  <!-- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤–∏–¥–∂–µ—Ç–∞ –ü–û–°–õ–ï –∑–∞–≥—Ä—É–∑–∫–∏ WebChat -->
  <script>
    // Token validation helper (simplified version from auth-utils)
    const isTokenValid = (token) => {
      if (!token) return false;
      try {
        const payload = token.split('.')[1];
        if (!payload) return false;
        const decoded = JSON.parse(atob(payload.replace(/-/g, '+').replace(/_/g, '/')));
        const now = Date.now() / 1000;
        return decoded.exp && decoded.exp > now;
      } catch (e) {
        return false;
      }
    };

    const load = () => {
      if (typeof WebChat === 'undefined') {
        setTimeout(load, 100);
        return;
      }

      const token = localStorage.getItem('chat_token');
      const hasValidToken = isTokenValid(token);

      // Gated dev log (enable via localStorage 'webchat:debug'=1 or ?webchat_debug=1)
      const __dbg = (() => {
        try {
          const ls = localStorage.getItem('webchat:debug');
          if (ls === '1' || ls === 'true') return true;
          return /([?&])webchat_debug=(1|true)\b/i.test(location.search);
        } catch(_) { return false; }
      })();
      const devLog = (...args) => { if (__dbg) console.log('[WebChat]', ...args); };
      devLog('üîç Token check:', hasValidToken ? 'Valid token found' : 'No valid token');

      WebChat.default({
        customData: {
          language: "en",
          ...(hasValidToken && { auth_header: token })
        },
        backendUrl: "https://rasa-stage-jb.labs.jb.gg",
        // Connect immediately if a token exists; otherwise, wait until the widget is opened
        connectOn: hasValidToken ? 'mount' : 'open',
        // Show the widget only if a token is present or when explicitly opened
        hideWhenNotConnected: !hasValidToken,
        // Rules work only with connectOn: 'mount'
        withRules: hasValidToken,
      });
    };

    // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
    setTimeout(load, 100);
  </script>

  <div style="width: 400px; height: 2000px; border: 3px solid lightsalmon;" id="webchat" />
</body>

</html>